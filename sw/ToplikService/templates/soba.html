<!doctype html>
<html lang="hr" data-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <title>Kontrola Sobe (Ispravljeno)</title>
    
    <style>
      main {
        max-width: 600px;
        margin: 2rem auto;
        padding: 1rem;
      }
      article {
        margin-bottom: 1.5rem;
      }
      
      /* --- Stilovi za header i slider (ostaju isti) --- */
      .termostat-header-wrapper {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--pico-muted-border-color);
        padding-bottom: 0.75rem;
      }
      .termostat-header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0; 
        border-bottom: none;
        padding-bottom: 0;
      }
      .termostat-header-wrapper label[for="switch-termostat-on-off"] {
        display: flex;
        align-items: center;
        font-size: 2rem;
        margin-bottom: 0;
        gap: 0.5rem;
      }
      .termostat-header-wrapper label[for^="switch-"] span {
         width: auto;
      }
      .termostat-header-wrapper input[role="switch"] {
        font-size: 1.8rem;
        margin: 0;
      }
      #current-temp-display {
        color: var(--pico-muted-color);
        font-weight: normal;
        font-size: 1.5rem;
        margin-left: 0.5rem;
      }
      .slider-container output {
        font-size: 3.5rem;
        font-weight: bold;
        display: block;
        text-align: center;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
      }
      .slider-container output::after {
        content: " °C";
        font-size: 2rem;
        color: var(--pico-muted-color);
        vertical-align: super;
      }
      .output-gray { color: var(--pico-muted-color) !important; }
      .output-blue { color: #007bff !important; }
      .output-green { color: #28a745 !important; }
      .output-red { color: #dc3545 !important; }
      .controls-article {
        /* Nema više text-align: center */
      }
      .controls-article .icon-header,
      .controls-article hr {
        width: 100%;
        text-align: center;
      }
      .slider-container { padding-top: 1rem; }
      input[type="range"] { width: 100%; }

      /* ===============================================================
       POPRAVAK: Poravnanje LIJEVO i DESNO (Flexbox)
      =============================================================== */
      
      /* "Kutija" koja drži sve prekidače */
      .switch-list-container {
        display: block; 
        width: 100%; /* Osigurava da zauzima punu širinu */
      }
      
      /* Svaki RED (label) je sada "tabela" (Flexbox) */
      .switch-list-container label[for^="switch-"] {
        display: flex;
        
        /* * #################################################
         * EVO GA PORAVNANJE (LIJEVO / DESNO)
         * "space-between" gura prvi element (tekst) LIJEVO,
         * a zadnji element (prekidač) DESNO.
         * #################################################
        */
        justify-content: space-between;
        
        align-items: center; /* Vertikalno centriranje */
        width: 100%; /* Svaki red je 100% širok */
        
        font-size: 2rem; /* Veliki font */
        margin-bottom: 1.5rem; /* Razmak između redova */
      }

      /* Veličina samog kliznog prekidača */
      .switch-list-container input[role="switch"] {
        font-size: 1.8rem;
        flex-shrink: 0; /* Ne daj mu da se smanji */
      }
      
      /* Blok [Ikona + Tekst] */
      label[for^="switch-"] span {
        display: flex;
        align-items: center;
        gap: 0.75rem; 
        width: auto; /* Nema fiksne širine */
      }


      /* ===============================================================
       "AUTORESIZE" ZA TELEFON (Sada samo smanjuje font)
      =============================================================== */
      @media (max-width: 500px) {
        
        main {
          margin: 0.5rem;
          padding: 0.5rem;
        }

        /* Smanjujemo fontove na mobitelu */
        .switch-list-container label[for^="switch-"] {
          font-size: 1.5rem;
          gap: 1rem; /* Manji razmak */
        }
        .switch-list-container input[role="switch"] {
          font-size: 1.3rem; 
        }

        /* Malo manji header */
        .termostat-header { font-size: 1.5rem; }
        .termostat-header-wrapper label[for="switch-termostat-on-off"] { font-size: 1.5rem; }
        .termostat-header-wrapper input[role="switch"] { font-size: 1.3rem; }
        .slider-container output { font-size: 3rem; }
      }

    </style>
  </head>
  <body>

    <main>
      <h1 style="text-align: center;">Kontrola Sobe</h1>

      <article>
        
        <div class="termostat-header-wrapper">
          
          <label for="switch-termostat-on-off">
            <span>
              <i class="bi bi-power"></i>
            </span>
            <input type="checkbox" id="switch-termostat-on-off" name="switch-termostat-on-off" role="switch" data-device="termostat_on_off">
          </label>
          
          <h3 class="termostat-header">
            <i class="bi bi-thermometer-half"></i>
            Temperatura
            <span id="current-temp-display"></span>
          </h3>
        </div>
        
        <div class="slider-container">
          <output id="temp-vrijednost">22</output>
          <input 
            type="range" 
            id="temp-slider" 
            name="temp-slider" 
            min="16" 
            max="30" 
            value="22"
            step="0.5"
            data-device="termostat_set"
          >
        </div>
      </article>
      
      <article class="controls-article">
        
        <h3 class="icon-header">
          <i class="bi bi-toggles"></i>
          Kontrole
        </h3>
        <hr>

        <div class="switch-list-container">
        
          <label for="switch-1">
            <span><i class="bi bi-lightbulb"></i>Glavno svjetlo</span>
            <input type="checkbox" id="switch-1" name="switch-1" role="switch" data-device="light_main">
          </label>
          
          <label for="switch-2">
            <span><i class="bi bi-lamp"></i>Ambijent</span>
            <input type="checkbox" id="switch-2" name="switch-2" role="switch" data-device="light_ambient">
          </label>

          <label for="switch-3">
            <span><i class="bi bi-lightbulb-fill"></i>Svjetlo (WC)</span>
            <input type="checkbox" id="switch-3" name="switch-3" role="switch" data-device="light_wc">
          </label>
          
          <label for="switch-4">
            <span><i class="bi bi-display"></i>Lampa (stol)</span>
            <input type="checkbox" id="switch-4" name="switch-4" role="switch" data-device="light_desk">
          </label>

          <label for="switch-5">
            <span><i class="bi bi-brightness-high"></i>Svjetlo (balkon)</span>
            <input type="checkbox"id="switch-5" name="switch-5" role="switch" data-device="light_balcony">
          </label>
          
        </div>
      </article>
    </main>
    
    <script>
      let state = {
        currentTemp: 22.0, 
      };
      const tempSlider = document.getElementById('temp-slider');
      const tempVrijednost = document.getElementById('temp-vrijednost');
      const thermostatSwitch = document.getElementById('switch-termostat-on-off');
      const currentTempDisplay = document.getElementById('current-temp-display');
      function updateUI() {
        const setpoint = parseFloat(tempSlider.value);
        const isON = thermostatSwitch.checked;
        tempVrijednost.textContent = setpoint.toFixed(1);
        currentTempDisplay.textContent = `${state.currentTemp.toFixed(0)}°C`; // Ovdje je izmjena
        tempVrijednost.classList.remove('output-gray', 'output-blue', 'output-green', 'output-red');
        if (!isON) {
          tempVrijednost.classList.add('output-gray');
        } else if (Math.abs(setpoint - state.currentTemp) <= 1.0) {
          tempVrijednost.classList.add('output-green');
        } else if (setpoint < state.currentTemp) {
          tempVrijednost.classList.add('output-blue');
        } else {
          tempVrijednost.classList.add('output-red');
        }
      }
      function posaljiKomandu(uredjaj, vrijednost) {
        console.log('Šaljem:', uredjaj, vrijednost);
        fetch('/api/control', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ uredjaj: uredjaj, vrijednost: vrijednost }),
        })
        .then(response => {
          if (!response.ok) {
            if (response.status === 401) {
              alert('Sesija je istekla. Molimo, prijavite se ponovo.');
              window.location.href = '/';
            }
            throw new Error('Greška pri slanju komande.');
          }
          return response.json();
        })
        .then(data => console.log('Server odgovara:', data.message))
        .catch(error => console.error(error));
      }
      function provjeriAutoUkljucenje() {
        if (!thermostatSwitch.checked) {
          console.log('Auto-uključujem termostat...');
          thermostatSwitch.checked = true;
          posaljiKomandu('termostat_on', true);
        }
      }
      document.querySelectorAll('input[role="switch"]').forEach(prekidac => {
        prekidac.addEventListener('change', (e) => {
          const uredjaj = e.target.dataset.device;
          const vrijednost = e.target.checked; 
          
          if (uredjaj === 'termostat_on_off') {
            const komanda = vrijednost ? 'termostat_on' : 'termostat_off';
            posaljiKomandu(komanda, true);
          } else {
            posaljiKomandu(uredjaj, vrijednost);
          }
          
          if (uredjaj === 'termostat_on_off') {
            updateUI();
          }
        });
      });
      tempSlider.addEventListener('input', (e) => {
        tempVrijednost.textContent = parseFloat(e.target.value).toFixed(1);
        provjeriAutoUkljucenje();
        updateUI();
      });
      tempSlider.addEventListener('change', (e) => {
        const uredjaj = e.target.dataset.device;
        const vrijednost = parseFloat(e.target.value);
        posaljiKomandu(uredjaj, vrijednost);
        updateUI(); 
      });
      document.addEventListener('DOMContentLoaded', () => {
        console.log('Stranica učitana, dohvaćam stvarni status sobe...');
        currentTempDisplay.textContent = '...';
        tempVrijednost.classList.add('output-gray');
        fetch('/api/status')
          .then(response => {
            if (!response.ok) { window.location.href = '/'; }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              console.log('Status primljen:', data);
              state.currentTemp = data.currentTemp;
              tempSlider.value = data.setpoint.toFixed(1);
              thermostatSwitch.checked = data.isThermostatOn;
              updateUI();
            } else {
              throw new Error(data.message);
            }
          })
          .catch(err => {
            console.error('Nije uspjelo dohvaćanje statusa:', err);
            currentTempDisplay.textContent = '(Greška)';
            updateUI();
          });
      });
    </script>
  </body>
</html>
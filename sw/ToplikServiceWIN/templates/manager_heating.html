<!doctype html>
<html lang="hr" data-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <title>Kontrola Grijanja (Fitness)</title>
    
    <style>
      main {
        max-width: 600px;
        margin: 2rem auto;
        padding: 1rem;
      }
      article {
        margin-bottom: 1.5rem;
      }
      
      /* --- Stilovi za header i slider --- */
      .termostat-header-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--pico-muted-border-color);
        padding-bottom: 0.75rem;
      }
      .termostat-header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0; 
        border-bottom: none;
        padding-bottom: 0;
      }
      #current-temp-display {
        color: var(--pico-muted-color);
        font-weight: normal;
        font-size: 1.5rem;
        margin-left: 0.5rem;
      }
      .slider-container output {
        font-size: 3.5rem;
        font-weight: bold;
        display: block;
        text-align: center;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
      }
      .slider-container output::after {
        content: " °C";
        font-size: 2rem;
        color: var(--pico-muted-color);
        vertical-align: super;
      }
      .output-gray { color: var(--pico-muted-color) !important; }
      .output-blue { color: #007bff !important; }
      .output-green { color: #28a745 !important; }
      .output-red { color: #dc3545 !important; }
      
      /* --- Kontrole --- */
      .controls-article .icon-header,
      .controls-article hr { width: 100%; text-align: center; }
      .slider-container { padding-top: 1rem; }
      input[type="range"] { width: 100%; }
      .switch-list-container { display: block; width: 100%; }
      .switch-list-container label[for^="switch-"] {
        display: flex; justify-content: space-between; align-items: center; 
        width: 100%; font-size: 2rem; margin-bottom: 1.5rem;
      }
      .switch-list-container input[role="switch"] { font-size: 1.8rem; flex-shrink: 0; }
      label[for^="switch-"] span { display: flex; align-items: center; gap: 0.75rem; width: auto; }

      /* --- Media Query --- */
      @media (max-width: 500px) {
        main { margin: 0.5rem; padding: 0.5rem; }
        .switch-list-container label[for^="switch-"] { font-size: 1.5rem; gap: 1rem; }
        .switch-list-container input[role="switch"] { font-size: 1.3rem; }
        .termostat-header { font-size: 1.5rem; }
        .termostat-header-wrapper { padding-bottom: 0.5rem; }
        .slider-container output { font-size: 3rem; }
      }
    </style>
  </head>
  <body>

    <main>
      <h1 style="text-align: center;">Kontrola Grijanja (Fitness)</h1>

      <article>
        <div class="termostat-header-wrapper">
          <h3 class="termostat-header">
            <i class="bi bi-thermometer-half"></i>
            <span>Temperatura</span>
            <span id="current-temp-display"></span>
          </h3>
        </div>
        
        <div class="slider-container">
          <output id="temp-vrijednost">22</output>
          <input 
            type="range" 
            id="temp-slider" 
            name="temp-slider" 
            min="16" 
            max="30" 
            value="22"
            step="1" data-device="fitness_thermostat_setpoint"
          >
        </div>

        <div class="switch-list-container">
          <label for="switch-thermostat-on-off">
            <span><i class="bi bi-power"></i> Termostat ON/OFF</span>
            <input type="checkbox" id="switch-thermostat-on-off" name="switch-thermostat-on-off" role="switch" data-device="fitness_thermostat_on_off">
          </label>
          <label for="switch-thermostat-mode">
            <span><i class="bi bi-fan"></i> Grijanje/Hlađenje</span>
            <input type="checkbox" id="switch-thermostat-mode" name="switch-thermostat-mode" role="switch" data-device="fitness_thermostat_mode">
          </label>
        </div>
      </article>
      
      <article class="controls-article">
        <h3 class="icon-header">
          <i class="bi bi-toggle-on"></i>
          <span>Pumpe</span>
        </h3>
        <hr>

        <div class="switch-list-container">
          <label for="switch-pump-fancoil">
            <span><i class="bi bi-arrow-repeat"></i> Pumpa Fancoil</span>
            <input type="checkbox" id="switch-pump-fancoil" name="switch-pump-fancoil" role="switch" data-device="pumpa_fancoil">
          </label>
          
          <label for="switch-pump-podno">
            <span><i class="bi bi-arrow-repeat"></i> Pumpa Podno</span>
            <input type="checkbox" id="switch-pump-podno" name="switch-pump-podno" role="switch" data-device="pumpa_podno">
          </label>
        </div>
      </article>
    </main>
    
    <script>
      // --------------------------------------------------------
      // JAVASCRIPT za Kontrolu Grijanja (Fitness)
      // --------------------------------------------------------

      let state = {
        currentTemp: 22.0,
        isThermostatOn: false,
        isHeatingMode: false, // true for heating, false for cooling
        pumpaFancoilOn: false,
        pumpaPodnoOn: false
      };
      let isPollingActive = true; 
      let isSliderDragging = false;
      
      const tempSlider = document.getElementById('temp-slider');
      const tempVrijednost = document.getElementById('temp-vrijednost');
      const currentTempDisplay = document.getElementById('current-temp-display');
      const thermostatOnOffSwitch = document.getElementById('switch-thermostat-on-off');
      const thermostatModeSwitch = document.getElementById('switch-thermostat-mode');
      const pumpaFancoilSwitch = document.getElementById('switch-pump-fancoil');
      const pumpaPodnoSwitch = document.getElementById('switch-pump-podno');

      function handleApiResponse(response) {
        if (response.status === 401) {
          alert('Sesija je istekla. Molimo, prijavite se ponovo.');
          window.location.href = '/manager'; 
          throw new Error('Sesija istekla');
        }
        if (!response.ok) {
          throw new Error('Greška servera: ' + response.statusText);
        }
        return response.json();
      }

      function posaljiKomandu(uredjaj, vrijednost, targetElement = null) {
        console.log('Šaljem:', uredjaj, vrijednost);
        
        if (targetElement) {
            targetElement.disabled = true;
        }

        isPollingActive = false; 
        setTimeout(() => { 
             isPollingActive = true;
             dohvatiStatus(true); 
        }, 4000);

        fetch('/api/manager/heating_control', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ uredjaj: uredjaj, vrijednost: vrijednost }),
        })
        .then(handleApiResponse)
        .then(data => {
            console.log('Server odgovara:', data.message);
            if (targetElement) {
                targetElement.disabled = false;
            }
        })
        .catch(error => {
            console.error(error);
            dohvatiStatus(true); 
            if (targetElement) {
                targetElement.disabled = false;
            }
        });
      }

      function dohvatiStatus(force = false) {
        if (!isPollingActive && !force) return;
        if (isSliderDragging) return; 

        fetch('/api/manager/heating_status')
          .then(handleApiResponse)
          .then(data => {
            if (data.success) {
              console.log('Status primljen:', data);
              updateUI(data.status);
            } else {
              throw new Error(data.message);
            }
          })
          .catch(err => {
            console.error('Nije uspjelo dohvaćanje statusa:', err);
            currentTempDisplay.textContent = '(Greška)';
          });
      }

      function updateUI(status) {
        if (!status) return;

        state.currentTemp = status.currentTemp || 22.0;
        currentTempDisplay.textContent = `${state.currentTemp.toFixed(0)}°C`; 
        
        if (!isSliderDragging) {
          const setpoint = (Math.round(status.setpoint) || 22.0).toFixed(0);
          if (tempSlider.value !== setpoint) {
            tempSlider.value = Math.round(status.setpoint || 22.0); 
          }
          if (tempVrijednost.textContent !== setpoint) {
            tempVrijednost.textContent = setpoint;
          }
        }
        
        azurirajBojuTemperature(true, parseFloat(tempSlider.value)); 

        // Thermostat ON/OFF
        if (thermostatOnOffSwitch.checked !== status.isThermostatOn) {
            thermostatOnOffSwitch.checked = status.isThermostatOn;
        }
        state.isThermostatOn = status.isThermostatOn;

        // Thermostat Mode (Heating/Cooling)
        if (thermostatModeSwitch.checked !== status.isHeatingMode) {
            thermostatModeSwitch.checked = status.isHeatingMode;
        }
        state.isHeatingMode = status.isHeatingMode;

        // Pumps
        if (pumpaFancoilSwitch.checked !== status.pumpaFancoilOn) {
            pumpaFancoilSwitch.checked = status.pumpaFancoilOn;
        }
        state.pumpaFancoilOn = status.pumpaFancoilOn;

        if (pumpaPodnoSwitch.checked !== status.pumpaPodnoOn) {
            pumpaPodnoSwitch.checked = status.pumpaPodnoOn;
        }
        state.pumpaPodnoOn = status.pumpaPodnoOn;
      }

      function azurirajBojuTemperature(isON, setpoint) {
        tempVrijednost.classList.remove('output-gray', 'output-blue', 'output-green', 'output-red');
        
        if (Math.abs(setpoint - state.currentTemp) <= 1.0) {
          tempVrijednost.classList.add('output-green');
        } else if (setpoint < state.currentTemp) {
          tempVrijednost.classList.add('output-blue');
        } else {
          tempVrijednost.classList.add('output-red');
        }
      }
      
      // --- EVENT LISTENER-I ---

      // Thermostat ON/OFF
      thermostatOnOffSwitch.addEventListener('change', (e) => {
          const vrijednost = e.target.checked;
          posaljiKomandu('fitness_thermostat_on_off', vrijednost, e.target);
      });

      // Thermostat Mode
      thermostatModeSwitch.addEventListener('change', (e) => {
          const vrijednost = e.target.checked; // true for heating, false for cooling
          posaljiKomandu('fitness_thermostat_mode', vrijednost, e.target);
      });

      // Pumps
      pumpaFancoilSwitch.addEventListener('change', (e) => {
          const vrijednost = e.target.checked;
          posaljiKomandu('pumpa_fancoil', vrijednost, e.target);
      });

      pumpaPodnoSwitch.addEventListener('change', (e) => {
          const vrijednost = e.target.checked;
          posaljiKomandu('pumpa_podno', vrijednost, e.target);
      });

      // Slider za temperaturu
      tempSlider.addEventListener('input', (e) => {
        tempVrijednost.textContent = Math.round(parseFloat(e.target.value)).toFixed(0); 
        azurirajBojuTemperature(true, parseFloat(e.target.value));
      });
      
      tempSlider.addEventListener('mousedown', () => { isSliderDragging = true; });
      tempSlider.addEventListener('touchstart', () => { isSliderDragging = true; });
      
      tempSlider.addEventListener('mouseup', () => { isSliderDragging = false; });
      tempSlider.addEventListener('touchend', () => { isSliderDragging = false; });

      tempSlider.addEventListener('change', (e) => { 
        isSliderDragging = false;
        const vrijednost = parseFloat(e.target.value);
        posaljiKomandu('fitness_thermostat_setpoint', vrijednost, null); 
      });

      // --- INICIJALIZACIJA STRANICE ---
      document.addEventListener('DOMContentLoaded', () => {
        console.log('Stranica za grijanje učitana, dohvaćam stvarni status...');
        currentTempDisplay.textContent = '...';
        tempVrijednost.classList.add('output-gray');
        dohvatiStatus(true); 

        setInterval(dohvatiStatus, 5000); 
      });

    </script>
  </body>
</html>